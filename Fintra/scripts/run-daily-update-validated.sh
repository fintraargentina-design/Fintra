#!/bin/bash
# Script de actualizaciรณn diaria - SECUENCIA VALIDADA
# Basado en el orden original del proyecto
# Uso: bash scripts/run-daily-update-validated.sh

set -e

BASE_URL="http://localhost:3000"
LOG_DIR="logs"
LOG_FILE="$LOG_DIR/cron-$(date +%Y%m%d-%H%M%S).log"

mkdir -p $LOG_DIR

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "โ  ๐ FINTRA - ACTUALIZACIรN DIARIA (Secuencia Validada)   โ" | tee -a $LOG_FILE
echo "โ  Fecha: $(date +'%Y-%m-%d %H:%M:%S')                         โ" | tee -a $LOG_FILE
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "" | tee -a $LOG_FILE

# Verificar servidor
echo "๐ Verificando servidor..." | tee -a $LOG_FILE
if ! curl -s --max-time 5 "$BASE_URL" > /dev/null 2>&1; then
  echo "โ ERROR: Servidor no estรก corriendo en $BASE_URL" | tee -a $LOG_FILE
  exit 1
fi
echo "โ Servidor OK" | tee -a $LOG_FILE
echo "" | tee -a $LOG_FILE

# Funciรณn helper
run_job() {
  local num=$1
  local name=$2
  local endpoint=$3
  local timeout=${4:-600}
  local critical=${5:-false}

  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
  echo "โ [$num] $name" | tee -a $LOG_FILE
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE

  START=$(date +%s)

  HTTP_CODE=$(timeout $timeout curl -s -o /tmp/response.json -w "%{http_code}" "$BASE_URL$endpoint" 2>&1)
  EXIT_CODE=$?

  END=$(date +%s)
  DURATION=$((END - START))

  if [ $EXIT_CODE -eq 0 ] && [ "$HTTP_CODE" == "200" ]; then
    echo "โ Completado en ${DURATION}s" | tee -a $LOG_FILE

    if jq -e '.processed' /tmp/response.json > /dev/null 2>&1; then
      PROCESSED=$(jq -r '.processed // 0' /tmp/response.json)
      echo "   ๐ Procesados: $PROCESSED" | tee -a $LOG_FILE
    fi
  else
    echo "โ FALLO (exit: $EXIT_CODE, HTTP: $HTTP_CODE)" | tee -a $LOG_FILE

    if [ -f /tmp/response.json ]; then
      cat /tmp/response.json | jq -r '.error // .message // .' 2>/dev/null | head -5 | tee -a $LOG_FILE
    fi

    if [ "$critical" == "true" ]; then
      echo "๐ฅ Job crรญtico fallรณ. Abortando." | tee -a $LOG_FILE
      exit 1
    fi
  fi

  echo "" | tee -a $LOG_FILE
  sleep 5
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FASE 1: UNIVERSO Y CLASIFICACIรN
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "โ  FASE 1: UNIVERSO Y CLASIFICACIรN                        โ" | tee -a $LOG_FILE
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "" | tee -a $LOG_FILE

run_job "1" "Sync Universe" "/api/cron/sync-universe" 600 true
run_job "2" "Industry Classification Sync" "/api/cron/industry-classification-sync" 900 false

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FASE 2: DATOS RAW (FMP API)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "โ  FASE 2: INGESTA DE DATOS RAW                            โ" | tee -a $LOG_FILE
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "" | tee -a $LOG_FILE

run_job "3" "Prices Daily Bulk" "/api/cron/prices-daily-bulk" 1200 true
run_job "4" "Financials Bulk" "/api/cron/financials-bulk" 1800 true
run_job "5" "Company Profile Bulk" "/api/cron/company-profile-bulk" 900 false

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FASE 3: AGREGADORES DE PERFORMANCE
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "โ  FASE 3: AGREGADORES DE PERFORMANCE                      โ" | tee -a $LOG_FILE
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "" | tee -a $LOG_FILE

run_job "6" "Industry Performance Aggregator 1D" "/api/cron/industry-performance-aggregator" 1200 false
run_job "7" "Sector Performance Aggregator 1D" "/api/cron/sector-performance-aggregator" 900 false
run_job "8" "Sector Performance Windows" "/api/cron/sector-performance-windows-aggregator" 1200 false
run_job "9" "Industry Performance Windows" "/api/cron/industry-performance-windows-aggregator" 1200 false

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FASE 4: PE AGGREGATORS (Nota: solo tienen core.ts, no route.ts)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Los PE aggregators probablemente se ejecutan dentro de sector-benchmarks
# Si tienen routes, descomentar:
# run_job "10" "Sector PE Aggregator" "/api/cron/sector-pe-aggregator" 600 false
# run_job "11" "Industry PE Aggregator" "/api/cron/industry-pe-aggregator" 600 false

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FASE 5: BENCHMARKS (CRรTICO PARA FGOS)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "โ  FASE 5: BENCHMARKS                                       โ" | tee -a $LOG_FILE
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "" | tee -a $LOG_FILE

run_job "12" "Sector Benchmarks" "/api/cron/sector-benchmarks" 900 true

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FASE 6: PERFORMANCE Y ESTADO
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "โ  FASE 6: PERFORMANCE Y MARKET STATE                      โ" | tee -a $LOG_FILE
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "" | tee -a $LOG_FILE

run_job "13" "Performance Bulk" "/api/cron/performance-bulk" 1200 false
run_job "14" "Market State Bulk" "/api/cron/market-state-bulk" 600 false
run_job "15" "Dividends Bulk V2" "/api/cron/dividends-bulk-v2" 900 false

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FASE 7: SNAPSHOTS FINALES (CORE - FGOS)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "โ  FASE 7: SNAPSHOTS FINALES (CRรTICO)                     โ" | tee -a $LOG_FILE
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "" | tee -a $LOG_FILE

run_job "16" "FMP Bulk Snapshots" "/api/cron/fmp-bulk" 7200 true

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FASE 8: VALIDACIรN
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "โ  FASE 8: HEALTHCHECK                                      โ" | tee -a $LOG_FILE
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "" | tee -a $LOG_FILE

run_job "17" "Healthcheck Snapshots" "/api/cron/healthcheck-fmp-bulk" 300 false

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# RESUMEN
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE
echo "โ  โ ACTUALIZACIรN COMPLETADA                              โ" | tee -a $LOG_FILE
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" | tee -a $LOG_FILE

rm -f /tmp/response.json

echo ""
echo "๐ Ver log completo: cat $LOG_FILE"
